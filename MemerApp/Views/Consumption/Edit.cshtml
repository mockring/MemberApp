@model MemerApp.Dtos.ConsumptionDto
@using MemerApp.Dtos
@using Newtonsoft.Json
@using Newtonsoft.Json.Serialization
@{
    ViewData["Title"] = "Edit Consumption";
}

<h2>編輯消費</h2>

<form id="consumptionEditForm" class="mb-4">
    @Html.AntiForgeryToken()
    <input type="hidden" id="consumptionId" name="consumptionId" value="@Model.MemberId" />

    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">會員電話</label>
            <div class="input-group">
                <input id="memberPhone" name="MemberPhone" class="form-control" value="@Model.MemberPhone" />
                <button id="btnLookupMember" type="button" class="btn btn-outline-secondary">查詢會員</button>
            </div>
        </div>
        <div class="col-md-4">
            <label class="form-label">會員姓名</label>
            <input id="memberName" name="MemberName" class="form-control" readonly value="@Model.MemberName" />
        </div>
        <div class="col-md-4">
            <label class="form-label">建立時間</label>
            <input id="createdDate" name="CreatedDate" type="datetime-local" class="form-control"
                   value="@Model.CreatedDate.ToString("yyyy-MM-ddTHH:mm")" />
        </div>
    </div>

    <h5>商品項目</h5>
    <table class="table table-bordered" id="linesTable">
        <thead>
            <tr>
                <th style="width:280px">關鍵字</th>
                <th style="width:280px">選擇產品</th>
                <th style="width:320px">產品名稱</th>
                <th style="width:120px">單價</th>
                <th style="width:100px">數量</th>
                <th style="width:120px">小計</th>
                <th style="width:140px">折扣(Coupon)</th>
                <th style="width:140px">折扣說明</th>
                <th style="width:140px">小計(折後)</th>
                <th style="width:80px"></th>
            </tr>
        </thead>
        <tbody id="linesBody">
            <!-- JS 會用 Model.Lines 新增行 -->
        </tbody>
    </table>

    <button id="btnAddLine" type="button" class="btn btn-sm btn-secondary mb-3">+ 新增商品</button>

    <div class="row">
        <div class="col-md-6 offset-md-6">
            <dl class="row">
                <dt class="col-sm-6">總金額 (未折扣)</dt>
                <dd class="col-sm-6 text-end"><span id="totalBefore">0</span></dd>

                <dt class="col-sm-6">總金額 (折後)</dt>
                <dd class="col-sm-6 text-end"><strong id="totalAfter">0</strong></dd>
            </dl>

            <div class="d-flex justify-content-end">
                <button id="btnSubmit" type="button" class="btn btn-primary">儲存變更</button>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <script>
        let coupons = [];
        let initialLines = @Html.Raw(JsonConvert.SerializeObject(
            Model.Lines ?? new List<MemerApp.Dtos.ConsumptionLineDto>(),
            new JsonSerializerSettings { ContractResolver = new CamelCasePropertyNamesContractResolver() }
        ));
        let memberPhoneInit = "@Model.MemberPhone";
        let memberNameInit = "@Html.Raw(Model.MemberName)";

        async function loadCoupons() {
            try {
                const res = await fetch('/Consumption/GetCoupons');
                if (!res.ok) return;
                coupons = await res.json();
            } catch (e) { console.error(e); }
        }

        function round2(v) { return Math.round((v + Number.EPSILON) * 100) / 100; }

        function createCouponSelect(selectedId) {
            const sel = document.createElement('select');
            sel.className = 'form-select form-select-sm coupon-select';
            sel.appendChild(Object.assign(document.createElement('option'), { value: '', textContent: '(無)' }));
            coupons.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.couponId;
                opt.textContent = `${c.couponName} (${c.calculationMethod} ${c.couponValue})`;
                if (selectedId && selectedId == c.couponId) opt.selected = true;
                sel.appendChild(opt);
            });
            sel.addEventListener('change', e => {
                const row = e.target.closest('tr'); recalcLine(row);
            });
            return sel;
        }

        function addLineFrom(initial) {
            const tbody = document.getElementById('linesBody');
            const tr = document.createElement('tr');

            tr.innerHTML = `
                <td>
                    <div class="input-group input-group-sm mb-1">
                        <input name="ProductKeyword" class="form-control product-keyword form-control-sm" placeholder="輸入產品關鍵字" value="${initial.productKeyword ?? ''}" />
                        <button type="button" class="btn btn-outline-secondary btn-sm btn-search-product">搜尋</button>
                    </div>
                </td>
                <td><div class="product-select-wrapper"></div></td>
                <td><input name="ProductName" class="form-control form-control-sm product-name" readonly value="${initial.productName ?? ''}" /></td>
                <td><input name="UnitPrice" class="form-control form-control-sm unit-price text-end" readonly value="${initial.unitPrice ?? 0}" /></td>
                <td><input name="Quantity" type="number" min="1" class="form-control form-control-sm quantity text-end" value="${initial.quantity ?? 1}" /></td>
                <td><input name="LineSubtotal" class="form-control form-control-sm line-subtotal text-end" readonly value="${initial.lineSubtotal ?? 0}" /></td>
                <td class="coupon-cell"></td>
                <td><input name="DiscountInfo" class="form-control form-control-sm discount-info" readonly value="${initial.discountInfo ?? ''}" /></td>
                <td><input name="LineTotal" class="form-control form-control-sm line-total text-end" readonly value="${initial.lineTotal ?? 0}" /></td>
                <td><button type="button" class="btn btn-sm btn-danger btn-remove-line">X</button></td>
            `;

            // append then add hidden product-id after row created
            tbody.appendChild(tr);

            // create hidden input for product-id (so buildPayload can find it)
            const hiddenId = document.createElement('input');
            hiddenId.type = 'hidden';
            hiddenId.name = 'ProductId';
            hiddenId.className = 'product-id';
            hiddenId.value = initial.productId ?? '';
            tr.appendChild(hiddenId);

            // populate coupon select
            const couponCell = tr.querySelector('.coupon-cell');
            couponCell.appendChild(createCouponSelect(initial.couponId));

            // events
            tr.querySelector('.btn-search-product').addEventListener('click', () => {
                const keyword = tr.querySelector('.product-keyword').value;
                if (!keyword) { alert('請輸入關鍵字'); return; }
                doProductSearch(keyword, tr); // 改為呼叫 doProductSearch，會建立 select
            });

            tr.querySelector('.quantity').addEventListener('input', () => recalcLine(tr));
            tr.querySelector('.btn-remove-line').addEventListener('click', () => { tr.remove(); recalcTotals(); });

            // if initial contains productId (from DB), we can fetch details to fill name/price:
            if (initial.productId) {
                fetchProductById(initial.productId, tr);
            } else {
                recalcLine(tr);
            }
        }

                // call search API and build select
        async function doProductSearch(keyword, row) {
            try {
                console.log('Searching products for:', keyword);
                const res = await fetch(`/Consumption/SearchProducts?keyword=${encodeURIComponent(keyword)}`);
                console.log('Search status', res.status);
                if (!res.ok) {
                    const txt = await res.text();
                    console.error('Search API error', txt);
                    alert('搜尋產品失敗：' + res.status);
                    return;
                }
                const list = await res.json();
                console.log('Search result:', list);
                buildProductSelect(row, list || []);
            } catch (e) {
                console.error('Search exception', e);
                alert('搜尋失敗（例外）');
            }
        }

        // build product select dropdown
        function buildProductSelect(row, products) {
            const wrapper = row.querySelector('.product-select-wrapper');
            if (!wrapper) {
                console.error('product-select-wrapper not found', row);
                return;
            }
            wrapper.innerHTML = '';
            if (!products || products.length === 0) {
                wrapper.innerHTML = `<div class="text-muted small">找不到結果</div>`;
                return;
            }

            const sel = document.createElement('select');
            sel.className = 'form-select form-select-sm product-select';
            const empty = document.createElement('option');
            empty.value = '';
            empty.textContent = '(請選擇)';
            sel.appendChild(empty);

            products.forEach(p => {
                const id = p.productId ?? p.ProductId;
                const name = p.productName ?? p.ProductName ?? '';
                const price = p.suggestedPrice ?? p.SuggestedPrice ?? p.SuggestedPrice ?? p.suggestedPrice ?? '';
                const opt = document.createElement('option');
                opt.value = id;
                opt.textContent = `${name} — 建議售價：${price}`;
                sel.appendChild(opt);
            });

            sel.addEventListener('change', () => {
                const pid = sel.value;
                if (!pid) return;
                // populate hidden id, name, price
                row.querySelector('.product-id').value = pid;
                const selected = products.find(x => (x.productId ?? x.ProductId) == pid);
                if (selected) {
                    row.querySelector('.product-name').value = selected.productName ?? selected.ProductName ?? '';
                    row.querySelector('.unit-price').value = (selected.suggestedPrice ?? selected.SuggestedPrice ?? selected.suggestedPrice ?? 0);
                }
                recalcLine(row);
            });

            wrapper.appendChild(sel);
        }

        async function fetchProductById(id, tr) {
            const r = await fetch(`/Consumption/GetProductById?id=${encodeURIComponent(id)}`);
            if (!r.ok) { alert('找不到產品'); return; }
            const p = await r.json();
            tr.querySelector('.product-name').value = p.productName;
            tr.querySelector('.unit-price').value = p.suggestedPrice ?? p.suggestedPrice;
            recalcLine(tr);
        }

        function recalcLine(tr) {
            const unit = parseFloat(tr.querySelector('.unit-price').value || 0);
            const qty = parseInt(tr.querySelector('.quantity').value || 0);
            const subtotal = round2(unit * qty);
            tr.querySelector('.line-subtotal').value = subtotal.toFixed(0);

            const couponSel = tr.querySelector('.coupon-select');
            const couponId = couponSel && couponSel.value ? parseInt(couponSel.value) : null;
            const coupon = couponId ? coupons.find(c => c.couponId == couponId) : null;

            let lineTotal = subtotal, discountInfo = '';
            if (coupon) {
                const method = (coupon.calculationMethod || coupon.calculationMethod).toString().toLowerCase();
                const val = parseFloat(coupon.couponValue || coupon.couponValue);
                switch (method) {
                    case '1': lineTotal = round2(subtotal * val); discountInfo = `x ${val}`; break;
                    case '0': lineTotal = round2(subtotal - val); discountInfo = `- ${val}`; break;
                }
            }
            if (lineTotal < 0) lineTotal = 0;
            tr.querySelector('.discount-info').value = discountInfo;
            tr.querySelector('.line-total').value = lineTotal.toFixed(0);
            recalcTotals();
        }

        function recalcTotals() {
            let before = 0, after = 0;
            document.querySelectorAll('#linesBody tr').forEach(tr => {
                before += parseFloat(tr.querySelector('.line-subtotal').value || 0);
                after += parseFloat(tr.querySelector('.line-total').value || 0);
            });
            document.getElementById('totalBefore').textContent = round2(before).toFixed(0);
            document.getElementById('totalAfter').textContent = round2(after).toFixed(0);
        }

        function buildPayload() {
            const dto = {
                memberId: @Model.MemberId,
                memberName: document.getElementById('memberName').value || '',
                memberPhone: document.getElementById('memberPhone').value || '',
                createdDate: document.getElementById('createdDate').value,
                lines: [],
                totalBeforeDiscount: parseFloat(document.getElementById('totalBefore').textContent || 0),
                totalAfterDiscount: parseFloat(document.getElementById('totalAfter').textContent || 0)
            };
            document.querySelectorAll('#linesBody tr').forEach(tr => {
                const couponSel = tr.querySelector('.coupon-select');
                const couponId = couponSel && couponSel.value ? parseInt(couponSel.value) : null;
                const coupon = couponId ? coupons.find(c => c.couponId == couponId) : null;
                dto.lines.push({
                    productId: parseInt(tr.querySelector('.product-id').value || 0),
                    productName: tr.querySelector('.product-name').value || '',
                    unitPrice: parseFloat(tr.querySelector('.unit-price').value || 0),
                    quantity: parseInt(tr.querySelector('.quantity').value || 0),
                    lineSubtotal: parseFloat(tr.querySelector('.line-subtotal').value || 0),
                    lineTotal: parseFloat(tr.querySelector('.line-total').value || 0),
                    couponId: couponId,
                    couponName: coupon ? coupon.couponName : null,
                    couponMethod: coupon ? coupon.calculationMethod : null,
                    couponValue: coupon ? coupon.couponValue : null,
                    discountAmount: round2(parseFloat(tr.querySelector('.line-subtotal').value) - parseFloat(tr.querySelector('.line-total').value))
                });
            });
            return dto;
        }

        async function submitEdit() {
            const dto = buildPayload();
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const id = @Model.MemberId;
            const res = await fetch(`/Consumption/Edit/${id}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'RequestVerificationToken': token },
                body: JSON.stringify(dto)
            });
            if (!res.ok) { alert('儲存失敗'); return; }
            const data = await res.json();
            if (data.success) {
                alert('儲存成功');
                location.href = '/Consumption';
            } else {
                alert('儲存回傳失敗');
            }
        }

        document.getElementById('btnAddLine').addEventListener('click', () => addLineFrom({}));

        document.getElementById('btnLookupMember').addEventListener('click', async () => {
            const phone = document.getElementById('memberPhone').value.trim();
            if (!phone) { alert('請輸入電話'); return; }
            const r = await fetch(`/Consumption/GetMemberByPhone?phone=${encodeURIComponent(phone)}`);
            if (!r.ok) { alert('找不到會員'); return; }
            const m = await r.json();
            document.getElementById('memberName').value = m.memberName ?? m.memberName;
        });

        document.getElementById('btnSubmit').addEventListener('click', () => submitEdit());

        (async () => {
            await loadCoupons();
            // 將 Model.Lines 加入 table
            if (initialLines && initialLines.length) {
                initialLines.forEach(l => {
                    addLineFrom({
                        productName: l.productName,
                        unitPrice: l.unitPrice,
                        quantity: l.quantity,
                        lineSubtotal: l.lineSubtotal,
                        lineTotal: l.lineTotal,
                        couponId: l.couponId,
                        discountInfo: '' // 會在 recalc 裡更新
                    });
                });
            } else {
                addLineFrom({});
            }
            // fill member fields
            document.getElementById('memberPhone').value = memberPhoneInit;
            document.getElementById('memberName').value = memberNameInit;
        })();
    </script>
}